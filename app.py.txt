from flask import Flask, render_template, request, redirect, url_for, flash, send_file
import sqlite3
import hashlib
from datetime import date
import openpyxl
import os

app = Flask(__name__)
app.secret_key = "secret123"

DB_NAME = "students.db"
ATTENDANCE_FILE = "attendance.xlsx"

# ---------- Initialize Database ----------
def init_db():
    conn = sqlite3.connect(DB_NAME)
    cur = conn.cursor()
    cur.execute("""CREATE TABLE IF NOT EXISTS students (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT,
                    roll_no TEXT,
                    password_hash TEXT)""")
    conn.commit()
    conn.close()

# ---------- Initialize Excel ----------
def init_excel():
    if not os.path.exists(ATTENDANCE_FILE):
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.append(["Date", "Name", "Roll No", "Status"])
        wb.save(ATTENDANCE_FILE)

# ---------- Save attendance ----------
def save_attendance(name, roll_no):
    wb = openpyxl.load_workbook(ATTENDANCE_FILE)
    ws = wb.active
    ws.append([date.today().isoformat(), name, roll_no, "Present"])
    wb.save(ATTENDANCE_FILE)

# ---------- Routes ----------
@app.route("/")
def index():
    return render_template("index.html")

@app.route("/register", methods=["POST"])
def register():
    name = request.form["name"]
    roll_no = request.form["roll_no"]
    password = request.form["password"]

    password_hash = hashlib.sha256(password.encode()).hexdigest()

    conn = sqlite3.connect(DB_NAME)
    cur = conn.cursor()
    cur.execute("INSERT INTO students (name, roll_no, password_hash) VALUES (?, ?, ?)",
                (name, roll_no, password_hash))
    conn.commit()
    conn.close()

    flash("Student Registered Successfully!", "success")
    return redirect(url_for("index"))

@app.route("/verify", methods=["POST"])
def verify():
    roll_no = request.form["roll_no"]
    password = request.form["password"]
    password_hash = hashlib.sha256(password.encode()).hexdigest()

    conn = sqlite3.connect(DB_NAME)
    cur = conn.cursor()
    cur.execute("SELECT name, roll_no FROM students WHERE roll_no=? AND password_hash=?", 
                (roll_no, password_hash))
    student = cur.fetchone()
    conn.close()

    if student:
        save_attendance(student[0], student[1])
        flash(f"Attendance marked for {student[0]} ({student[1]})", "success")
    else:
        flash("Invalid credentials! Please try again.", "danger")

    return redirect(url_for("index"))

@app.route("/download")
def download():
    return send_file(ATTENDANCE_FILE, as_attachment=True)

if __name__ == "__main__":
    init_db()
    init_excel()
    app.run(debug=True)
